## DB主从一致性架构优化

[原文](https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651959442&idx=1&sn=feb8ff75385d8031386e120ef3535329&scene=21#wechat_redirect)
### 为什么需要优化
从库单进程执行reloy-log,和通讯网络,由于主从延时导致读取到旧数据

### 主从和主备的区别
- 从:仆人,替主分忧,可读
- 备:备份,备胎 主不可用,备份继续

### 数据集中和分散集群
- 集中: 一主多从  *数据集中在一台服务器上,其他服务器备份*
- 分散: 数据分散到多个集群,*每台服务器存储一部分数据,其他服务器可以备份一部分数据* **kafka es**
    1. 负责数据分区算法的机器叫**主机**,hadoop的为独立主机**namenode** es的为选举的主机**master node**
    2. ![hadoop](https://hadoop.apache.org/docs/r1.0.4/cn/images/hdfsarchitecture.gif)

### 怎么优化

1. 半同步复制
    - 系统先对DB-master进行了一个写操作，写主库
    - 等主从同步完成，写主库的请求才返回
    - 读从库，读到最新的数据
优点：利用数据库原生功能，比较简单 缺点：主库的写请求时延会增长，吞吐量会降低

2. 强制读主库
优点：“一致性”上不需要进行系统改造 缺点：只能通过cache来提升系统的读性能，这里要进行系统改造

3. 数据库中间件
    - 所有的读写都走数据库中间件，通常情况下，写请求路由到主库，读请求路由到从库
    - 记录所有路由到写库的key，在经验主从同步时间窗口内（假设是500ms），如果有读请求访问中间件，此时有可能从库还是旧数据，就把这个key上的读请求路由到主库
    - 经验主从同步时间过完后，对应key的读请求继续路由到从库
优点：能保证绝对一致   缺点：数据库中间件的成本比较高

4. 缓存记录写key法
    - 将某个库上的某个key要发生写操作，记录在cache里，并设置“经验主从同步时间”的cache超时时间，例如500ms
    - 修改数据库
优点：相对数据库中间件，成本较低   缺点：为了保证“一致性”，引入了一个cache组件，并且读写数据库时都多了一步cache操作

5. 写操作后的读操作指定发给数据库主服务器(代码层面实现)

6. 读从机失败后再读一次主机(二次读取多,主压力大)

7. 关键业务读写操作全部指向主机，非关键业务采用读写分离
   
   
   

    